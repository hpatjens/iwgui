<html>
    <style>
        button {
            display: block;
        }

        .row {
            display: flex;
        }

        .column {
            flex: 50%;
        }
    </style>
    <script>
        let to_browser_socket = new WebSocket("ws://localhost:9001")
        let to_server_socket = new WebSocket("ws://localhost:9001")
        let uuid = #uuid

        /// true when the object has to properties, otherwise false
        function is_empty(obj) {
            console.assert(obj, { errorMsg: "value must be truthly" })
            return Object.keys(obj).length === 0 && obj.constructor === Object
        }

        /// Returns the first value of the object
        function first_value(obj) {
            console.assert(obj, { errorMsg: "value must be truthly" })
            console.assert(Object.keys(obj).length > 0, { number: Object.keys(obj).length, errorMsg: "no first element available" })
            return obj[Object.keys(obj)[0]]
        }

        /// Returns the first key of the object
        function first_key(obj) {
            console.assert(obj, { errorMsg: "value must be truthly" })
            console.assert(Object.keys(obj).length > 0, { number: Object.keys(obj).length, errorMsg: "no first element available" })
            return Object.keys(obj)[0]
        }

        /// Removes the first key-value pair of the object and returns it
        function pop_first_value(obj) {
            console.assert(obj, { errorMsg: "value must be truthly" })
            var result = first_value(obj)
            delete obj[Object.keys(obj)[0]]
            return result
        }

        function pop_first_property(obj) {
            console.assert(obj, { errorMsg: "value must be truthly" })
            var key = first_key(obj)
            var value = first_value(obj)
            delete obj[Object.keys(obj)[0]]
            return [key, value]
        }

        function instantiate_element(gui_id, element, added, new_dom_elements) {
            console.assert(gui_id, { errorMsg: "value must be truthly" })
            console.assert(element, { errorMsg: "value must be truthly" })
            console.assert(added, { errorMsg: "value must be truthly" })
            // A button is encoded as follows: "{\"Button\":{\"text\":\"My Button\"}}"
            // To find out the type of the element to add, we can just look at the first property
            var type = first_key(element)
            switch (type) {
                case "StackLayout": 
                    /* <div>{}</div> */
                    let stack_layout = document.createElement("div")
                    for (const child_gui_id of element.StackLayout.children) {
                        if (child_gui_id in new_dom_elements) {
                            stack_layout.appendChild(new_dom_elements[child_gui_id])
                            delete new_dom_elements[child_gui_id]
                        } else {
                            let child_element = added[child_gui_id]
                            delete added[child_gui_id]
                            let child = instantiate_element(child_gui_id, child_element, added, new_dom_elements)
                            stack_layout.appendChild(child)
                        }
                    }
                    return stack_layout
                case "Columns":
                    /*
                    <div class="row">
                        <div class="column">{}</div>
                        <div class="column">{}</div>
                    </div>
                    */
                    // Parent
                    let columns = document.createElement("div")
                    columns.classList.add("row")
                    // Left child
                    let left = document.createElement("div")
                    columns.appendChild(left)
                    left.classList.add("column")
                    let left_gui_id = element.Columns.left
                    if (left_gui_id in new_dom_elements) {
                        left.appendChild(new_dom_elements[left_gui_id])
                        delete new_dom_elements[left_gui_id]
                    } else {
                        let left_element = added[left_gui_id]
                        delete added[left_gui_id]
                        let left_content = instantiate_element(left_gui_id, left_element, added, new_dom_elements)
                        left.appendChild(left_content)
                    }
                    // Right child
                    let right = document.createElement("div")
                    columns.appendChild(right)
                    right.classList.add("column")
                    let right_gui_id = element.Columns.right
                    if (right_gui_id in new_dom_elements) {
                        right.appendChild(new_dom_elements[right_gui_id])
                        delete new_dom_elements[right_gui_id]
                    } else {
                        let right_element = added[right_gui_id]
                        delete added[right_gui_id]
                        let right_content = instantiate_element(right_gui_id, right_element, added, new_dom_elements)
                        right.appendChild(right_content)
                    }
                    return columns
                case "Button":
                    let button = document.createElement("button")
                    if (element.Button.text) {
                        button.innerHTML = element.Button.text
                    } else {
                        button.innerHTML = "Button"
                    }
                    console.log("button: ", element.Button)
                    button.addEventListener ("click", function() {
                        send_event({"ButtonPressed":gui_id})
                    });
                    return button
                case "Label": 
                    let label = document.createElement("div")
                    label.innerHTML = element.Label
                    return label
                case "Header":
                    let header = document.createElement("h1")
                    header.innerHTML = element.Header
                    return header
                default:
                    console.error({ errorMsg: "Unknown type of element", type: type })
            }
        }

        to_browser_socket.onopen = function(e) {
            // Send the welcome message to the server to register this websocket as the one responsible for the server-browser connection
            to_browser_socket.send(JSON.stringify({
                "Welcome":{
                    "direction":"ToBrowser",
                    "uuid":uuid
                }
            }))
        }
        to_browser_socket.onmessage = function(event) {
            // This is a serialized `ServerBrowserUpdate` on the Rust side
            var server_browser_update = JSON.parse(event.data)

            // Debug
            // TODO: remove this
            for (const added_gui_id in server_browser_update.added) {
                console.log(`${added_gui_id} -> ${JSON.stringify(server_browser_update.added[added_gui_id])}`)
            }

            // Get first added element
            var new_dom_elements = {}; // TODO: Rename this to something like: waiting_dom_elements
            while (!is_empty(server_browser_update.added)) {
                let [gui_id, element] = pop_first_property(server_browser_update.added)
                new_dom_elements[gui_id] = instantiate_element(gui_id, element, server_browser_update.added, new_dom_elements)
            }
            console.log(Object.keys(new_dom_elements).length)
            if (Object.keys(new_dom_elements).length === 1) {
                document.body.innerHTML = ""
                document.body.appendChild(pop_first_value(new_dom_elements))
            } else {

            }
            


        }
        to_browser_socket.onclose = function(event) {
            if (event.wasClean) {
                console.log(`[close] Connection closed cleanly, code=${event.code} reason=${event.reason}`)
            } else {
                console.log('[close] Connection died')
            }
        }
        to_browser_socket.onerror = function(error) {
            console.log(`[error] ${error.message}`)
        }


        
        to_server_socket.onopen = function(e) {
            // Send the welcome message to the server to register this websocket as the one responsible for the browser-server connection
            to_server_socket.send(JSON.stringify({
                "Welcome":{
                    "direction":"ToServer",
                    "uuid":uuid
                }
            }))
        }
        to_server_socket.onmessage = function(event) {
            console.log("[Error] onmessage called on to_server_socket")
        }
        to_server_socket.onclose = function(event) {
            if (event.wasClean) {
                console.log(`[close] Connection closed cleanly, code=${event.code} reason=${event.reason}`)
            } else {
                console.log('[close] Connection died')
            }
        }
        to_server_socket.onerror = function(error) {
            console.log(`[error] ${error.message}`)
        }





        function send_event(event) {
            var event = JSON.stringify(event)
            to_server_socket.send(event)
            console.log("Sent event: " + event)
        }
    </script>
    <body>
        
    </body>
</html>